<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ganjoor Poem Pretty Printer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Vazirmatn", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5em;
        font-weight: 500;
        font-family: "Vazirmatn", sans-serif;
      }

      .header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1.1em;
      }

      .input-section {
        padding: 30px;
        border-bottom: 1px solid #eee;
      }

      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      input[type="url"] {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        font-family: "Vazirmatn", sans-serif;
        direction: ltr;
        text-align: left;
      }

      input[type="url"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        font-family: "Vazirmatn", sans-serif;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        padding: 10px 15px;
        border-radius: 8px;
        margin-top: 10px;
        display: none;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.loading {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .poem-container {
        padding: 40px;
        display: none;
      }

      .poem-header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .poet-name {
        font-size: 1.8em;
        color: #333;
        margin-bottom: 10px;
        font-weight: bold;
      }

      .poem-title {
        font-size: 1.3em;
        color: #666;
        font-style: italic;
      }

      .poem-content {
        line-height: 2.2;
        font-size: 1.2em;
        color: #333;
        text-align: center;
        max-width: 800px;
        margin: 0 auto;
      }

      .verse {
        margin-bottom: 25px;
        padding: 15px;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 10px;
        border-right: 4px solid #667eea;
      }

      .hemistichs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: center;
      }

      .hemistich {
        padding: 10px;
      }

      .hemistich:first-child {
        text-align: left;
      }

      .hemistich:last-child {
        text-align: right;
      }

      .print-section {
        text-align: center;
        padding: 20px;
        border-top: 1px solid #eee;
      }

      .print-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        padding: 15px 30px;
        font-size: 18px;
      }

      /* Print Styles */
      @media print {
        body {
          background: white;
          margin: 0;
          padding: 0;
        }

        .container {
          box-shadow: none;
          border-radius: 0;
          max-width: 100%;
        }

        .header {
          background: #333 !important;
          -webkit-print-color-adjust: exact;
          color-adjust: exact;
        }

        .input-section,
        .print-section {
          display: none;
        }

        .poem-container {
          display: block !important;
          padding: 20px;
        }

        .verse {
          background: #f8f9fa !important;
          -webkit-print-color-adjust: exact;
          color-adjust: exact;
          break-inside: avoid;
          margin-bottom: 20px;
        }

        .hemistichs {
          gap: 15px;
        }

        .poem-content {
          font-size: 1.1em;
          line-height: 2;
        }
      }

      @media (max-width: 768px) {
        .hemistichs {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .hemistich:first-child,
        .hemistich:last-child {
          text-align: center;
        }

        .input-group {
          flex-direction: column;
        }

        .header h1 {
          font-size: 2em;
        }

        .poem-content {
          font-size: 1.1em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>گنجور - چاپ زیبای شعر</h1>
        <p>ابزار چاپ زیبا و مناسب برای اشعار گنجور</p>
      </div>

      <div class="input-section">
        <div class="input-group">
          <input
            type="url"
            id="urlInput"
            placeholder="لینک شعر از گنجور را اینجا وارد کنید..."
            value="https://ganjoor.net/adib/divan/ghete/sh34#pretab"
          />
          <button onclick="extractPoem()" id="extractBtn">استخراج شعر</button>
          <button
            onclick="loadSamplePoem()"
            style="
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            "
          >
            نمونه شعر
          </button>
        </div>
        <div id="status" class="status"></div>

        <!-- Manual input section (initially hidden) -->
        <div
          id="manualSection"
          style="
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
          "
        >
          <h3 style="color: #666; margin-bottom: 15px">ورود دستی متن شعر</h3>
          <div style="margin-bottom: 15px">
            <input
              type="text"
              id="manualPoetName"
              placeholder="نام شاعر"
              style="
                width: 48%;
                margin-left: 2%;
                padding: 10px;
                border: 2px solid #ddd;
                border-radius: 5px;
              "
            />
            <input
              type="text"
              id="manualPoemTitle"
              placeholder="عنوان شعر"
              style="
                width: 48%;
                padding: 10px;
                border: 2px solid #ddd;
                border-radius: 5px;
              "
            />
          </div>
          <textarea
            id="manualPoemText"
            placeholder="متن شعر را اینجا بنویسید... (هر بیت در یک خط)"
            style="
              width: 100%;
              height: 200px;
              padding: 15px;
              border: 2px solid #ddd;
              border-radius: 8px;
              font-family: Tahoma;
              font-size: 14px;
              line-height: 1.6;
              resize: vertical;
            "
          ></textarea>
          <button onclick="processManualInput()" style="margin-top: 10px">
            نمایش شعر
          </button>
        </div>
      </div>

      <div class="poem-container" id="poemContainer">
        <div class="poem-header">
          <div class="poet-name" id="poetName"></div>
          <div class="poem-title" id="poemTitle"></div>
        </div>
        <div class="poem-content" id="poemContent"></div>
      </div>

      <div class="print-section" id="printSection" style="display: none">
        <button onclick="window.print()" class="print-btn">چاپ شعر</button>
      </div>
    </div>

    <script>
      function showStatus(message, type) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
        status.style.display = "block";
      }

      function hideStatus() {
        const status = document.getElementById("status");
        status.style.display = "none";
      }

      async function extractPoem() {
        const urlInput = document.getElementById("urlInput").value.trim();
        const extractBtn = document.getElementById("extractBtn");
        const pathMatch = urlInput.match(/ganjoor\.net\/([^#?]+)/i);

        if (!pathMatch) {
          showStatus("لینک وارد شده معتبر نیست.", "error");
          return;
        }

        const poemPath = "/" + pathMatch[1]; // Add leading slash

        try {
          showStatus("در حال دریافت شعر از API گنجور...", "loading");
          extractBtn.disabled = true;

          // First, get the poem basic info
          const poemRes = await fetch(
            `https://api.ganjoor.net/api/ganjoor/poem?url=${encodeURIComponent(
              poemPath
            )}`
          );
          if (!poemRes.ok) throw new Error(`کد خطا ${poemRes.status}`);

          const poem = await poemRes.json();

          // Then get the verses using the poem ID
          const versesRes = await fetch(
            `https://api.ganjoor.net/api/ganjoor/poem/${poem.id}/verses`
          );
          if (!versesRes.ok)
            throw new Error(`کد خطا در دریافت ابیات ${versesRes.status}`);

          const verses = await versesRes.json();

          const title = poem.title || "بدون عنوان";
          const poet =
            poem.category?.poet?.name || poem.poetName || "شاعر ناشناس";

          // Process verses - each verse may have multiple hemistichs
          const poemText = verses
            .map((verse) => {
              if (verse.hemistichs && verse.hemistichs.length > 0) {
                return verse.hemistichs.map((h) => h.text || "").join("   "); // Join hemistichs with spacing
              }
              return verse.text || ""; // Fallback to verse.text if hemistichs not available
            })
            .filter((line) => line.trim()) // Remove empty lines
            .join("\n");

          displayPoem(poet, title, poemText);
          showStatus("شعر با موفقیت استخراج شد!", "success");
          setTimeout(hideStatus, 3000);
        } catch (err) {
          console.error(err);
          showStatus("خطا در دریافت شعر: " + err.message, "error");
        } finally {
          extractBtn.disabled = false;
        }
      }
      function extractPoemFromHTML(doc) {
        // Try different selectors that might contain the poem
        const selectors = [
          'div[style*="font-size"]', // Common in Ganjoor
          ".poem",
          ".poetry",
          "#poemtext",
          ".verse",
          'div:contains("زیرا")', // Look for Persian text patterns
        ];

        let poemText = "";

        // Look for the main content area
        const bodyText = doc.body.textContent;
        const lines = bodyText
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0);

        // Find poem lines (typically Persian text with specific patterns)
        const poemLines = [];
        let foundPoetry = false;

        for (let line of lines) {
          // Skip navigation, headers, and footer content
          if (line.includes("گنجور") && line.includes("»")) continue;
          if (line.includes("با انتخاب متن")) break;
          if (line.includes("هوش مصنوعی")) break;
          if (line.includes("پیشنهاد تصاویر")) break;
          if (line.length < 10) continue;
          if (line.includes("حاشیه")) break;

          // Look for Persian poetry patterns
          if (isPersianPoetryLine(line)) {
            poemLines.push(line);
            foundPoetry = true;
          } else if (foundPoetry && line.length > 20) {
            // Continue collecting if we've found poetry and line is substantial
            poemLines.push(line);
          }
        }

        return poemLines.join("\n");
      }

      function isPersianPoetryLine(line) {
        // Check for Persian characters and poetry patterns
        const persianPattern = /[\u0600-\u06FF]/;
        const hasRhyme =
          line.includes("رفت") || line.includes("شد") || line.includes("است");
        const hasPoetryStructure = line.length > 20 && line.length < 200;

        return persianPattern.test(line) && hasPoetryStructure;
      }

      function extractPoetName(doc) {
        const title = doc.title;
        if (title && title.includes("»")) {
          const parts = title.split("»");
          return parts[1]?.trim() || "شاعر ناشناس";
        }
        return "شاعر ناشناس";
      }

      function extractPoemTitle(doc) {
        const title = doc.title;
        if (title && title.includes("»")) {
          const parts = title.split("»");
          return parts[parts.length - 1]?.trim() || "بدون عنوان";
        }
        return "بدون عنوان";
      }

      function displayPoem(poetName, poemTitle, poemText) {
        document.getElementById("poetName").textContent = poetName;
        document.getElementById("poemTitle").textContent = poemTitle;

        const poemContent = document.getElementById("poemContent");
        const lines = poemText
          .split("\n")
          .filter((line) => line.trim().length > 0);

        let formattedPoem = "";

        for (let i = 0; i < lines.length; i += 2) {
          const line1 = lines[i];
          const line2 = lines[i + 1];

          if (line1 && line2) {
            // Two lines - create hemistichs
            formattedPoem += `
                        <div class="verse">
                            <div class="hemistichs">
                                <div class="hemistich">${line1}</div>
                                <div class="hemistich">${line2}</div>
                            </div>
                        </div>
                    `;
          } else if (line1) {
            // Single line
            formattedPoem += `
                        <div class="verse">
                            <div style="text-align: center;">${line1}</div>
                        </div>
                    `;
          }
        }

        poemContent.innerHTML = formattedPoem;
        document.getElementById("poemContainer").style.display = "block";
        document.getElementById("printSection").style.display = "block";
      }

      // Handle Enter key in URL input
      document
        .getElementById("urlInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            extractPoem();
          }
        });

      function showManualInputOption() {
        document.getElementById("manualSection").style.display = "block";

        // Try to pre-fill with the sample poem if available
        const samplePoem = `بیچاره آدمی که گرفتار عقل شد
خوش آن کسی که کره خر آمد الاغ رفت
ای باغبان منال ز رنج دی و خزان
بنشین بجای و فاتحه برخوان که باغ رفت
ای پاسبان مخسب که در غارت سرای
دزد دغل به خانه تو با چراغ رفت
ای دهخدا عراق و ری و طوس هم نماند
چو بانه رفت و سقز و ساوجبلاغ رفت
یاران حذر کنید که در بوستان عدل
امروز جوقه جوقه بسی بوم و زاغ رفت`;

        document.getElementById("manualPoetName").value = "ادیب الممالک";
        document.getElementById("manualPoemTitle").value = "مقطعات - شماره ۳۴";
        document.getElementById("manualPoemText").value = samplePoem;
      }

      function processManualInput() {
        const poetName =
          document.getElementById("manualPoetName").value.trim() ||
          "شاعر ناشناس";
        const poemTitle =
          document.getElementById("manualPoemTitle").value.trim() ||
          "بدون عنوان";
        const poemText = document.getElementById("manualPoemText").value.trim();

        if (!poemText) {
          showStatus("لطفاً متن شعر را وارد کنید.", "error");
          return;
        }

        displayPoem(poetName, poemTitle, poemText);
        showStatus("شعر با موفقیت نمایش داده شد!", "success");
        setTimeout(hideStatus, 3000);
      }
    </script>
  </body>
</html>
